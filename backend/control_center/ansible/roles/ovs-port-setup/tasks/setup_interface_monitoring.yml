---
- name: Create interface monitor directory
  file:
    path: "/mnt/interface-monitor"
    state: directory
    mode: "0755"

- name: Create log file with correct ownership and permissions
  file:
    path: "/var/log/interface_monitor.log"
    state: touch
    owner: root
    group: root
    mode: "0644"

- name: Create interface monitoring script
  copy:
    dest: "/mnt/interface-monitor/monitor_interfaces.sh"
    content: |
      #!/bin/bash
      # Network Interface Monitor Script
      # Monitors USB-to-Ethernet adapters and brings them up if they're down
      # Interfaces: {{ interfaces | join(', ') }}

      # Configuration
      INTERFACES=({{ interfaces | map('quote') | join(' ') }})
      LOG_FILE="/var/log/interface_monitor.log"
      LOCK_FILE="/var/run/interface_monitor.lock"

      # Function to log messages with timestamp
      log_message() {
          echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE" 2>/dev/null
      }

      # Function to check if interface is up
      is_interface_up() {
          local interface="$1"
          # Check if interface exists and is UP
          if ip link show "$interface" 2>/dev/null | grep -q "state UP"; then
              return 0  # Interface is up
          else
              return 1  # Interface is down
          fi
      }

      # Function to bring interface up
      bring_interface_up() {
          local interface="$1"
          log_message "Attempting to bring up interface: $interface"
          
          # Try to bring the interface up
          if ip link set "$interface" up 2>/dev/null; then
              # Wait a moment for the interface to stabilize
              sleep 2
              
              # Check if it's actually up now
              if is_interface_up "$interface"; then
                  log_message "SUCCESS: Interface $interface is now UP"
                  return 0
              else
                  log_message "WARNING: Interface $interface command succeeded but interface still appears down"
                  return 1
              fi
          else
              log_message "ERROR: Failed to bring up interface $interface"
              return 1
          fi
      }

      # Function to check if script is already running
      check_lock() {
          if [ -f "$LOCK_FILE" ]; then
              local pid=$(cat "$LOCK_FILE")
              if kill -0 "$pid" 2>/dev/null; then
                  log_message "WARNING: Monitor script already running (PID: $pid)"
                  exit 1
              else
                  # Lock file exists but process is dead, remove it
                  rm -f "$LOCK_FILE"
              fi
          fi
      }

      # Function to create lock file
      create_lock() {
          echo $$ > "$LOCK_FILE"
      }

      # Function to cleanup lock file
      cleanup() {
          rm -f "$LOCK_FILE"
          exit 0
      }

      # Set up signal handlers for cleanup
      trap cleanup EXIT INT TERM

      # Main monitoring function
      main() {
          # Check for lock file to prevent multiple instances
          check_lock
          create_lock
          
          log_message "Starting interface monitoring check"
          
          local interfaces_brought_up=0
          
          # Check each interface
          for interface in "${INTERFACES[@]}"; do
              if is_interface_up "$interface"; then
                  log_message "Interface $interface is UP - OK"
              else
                  log_message "Interface $interface is DOWN - attempting to bring up"
                  if bring_interface_up "$interface"; then
                      ((interfaces_brought_up++))
                  fi
              fi
          done
          
          # Summary
          if [ $interfaces_brought_up -gt 0 ]; then
              log_message "SUMMARY: Brought up $interfaces_brought_up interface(s)"
          else
              log_message "SUMMARY: All interfaces are UP - no action needed"
          fi
          
          log_message "Interface monitoring check completed"
      }

      # Run main function (redirect all output to /dev/null to avoid console output)
      main "$@" > /dev/null 2>&1
    mode: "0755"

- name: Create systemd service file for interface monitor
  copy:
    dest: "/etc/systemd/system/interface-monitor.service"
    content: |
      [Unit]
      Description=Network Interface Monitor
      Documentation=Monitor USB-to-Ethernet adapters and bring them up if down
      After=network.target

      [Service]
      Type=oneshot
      ExecStart=/mnt/interface-monitor/monitor_interfaces.sh
      User=root
      StandardOutput=journal
      StandardError=journal

      [Install]
      WantedBy=multi-user.target
    mode: "0644"

- name: Create systemd timer file for interface monitor
  copy:
    dest: "/etc/systemd/system/interface-monitor.timer"
    content: |
      [Unit]
      Description=Network Interface Monitor Timer
      Requires=interface-monitor.service

      [Timer]
      OnBootSec=30s
      OnUnitActiveSec=30s
      Persistent=true

      [Install]
      WantedBy=timers.target
    mode: "0644"

- name: Create logrotate configuration for interface monitor
  copy:
    dest: "/etc/logrotate.d/interface-monitor"
    content: |
      /var/log/interface_monitor.log {
          daily
          rotate 7
          compress
          delaycompress
          missingok
          notifempty
          create 644 root root
          maxsize 3M
      }
    mode: "0644"

- name: Reload systemd to pick up new service and timer files
  ansible.builtin.systemd:
    daemon_reload: yes

- name: Enable and start interface monitor timer
  ansible.builtin.systemd:
    name: "interface-monitor.timer"
    enabled: yes
    state: started
